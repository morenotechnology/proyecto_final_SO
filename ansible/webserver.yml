---
- name: Configurar servidor web Nginx con Node Exporter
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    node_exporter_version: "1.7.0"
    node_exporter_arch_map:
      x86_64: amd64
      amd64: amd64
      aarch64: arm64
      arm64: arm64
    node_exporter_arch: "{{ node_exporter_arch_map.get(ansible_architecture, 'amd64') }}"
    node_exporter_package: "node_exporter-{{ node_exporter_version }}.linux-{{ node_exporter_arch }}"
  
  tasks:
    - name: Actualizar cache de apt
      apt:
        update_cache: yes
        cache_valid_time: 3600
      register: apt_update
      retries: 3
      delay: 10
      until: apt_update is success
    
    - name: Instalar paquetes necesarios
      apt:
        name:
          - nginx
          - curl
          - wget
        state: present
      register: apt_install
      retries: 3
      delay: 10
      until: apt_install is success
    
    - name: Iniciar y habilitar Nginx
      systemd:
        name: nginx
        state: started
        enabled: yes
    
    - name: Crear p√°gina web personalizada
      copy:
        content: |
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>DataExplorer - Proyecto Final</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      color: white;
                      padding: 20px;
                  }
                  .container {
                      background: rgba(255,255,255,0.1);
                      padding: 50px;
                      border-radius: 20px;
                      backdrop-filter: blur(10px);
                      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
                      border: 1px solid rgba(255, 255, 255, 0.18);
                      max-width: 700px;
                      text-align: center;
                  }
                  h1 { 
                      font-size: 3.5em; 
                      margin-bottom: 30px;
                      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                  }
                  .subtitle {
                      font-size: 1.5em;
                      margin-bottom: 40px;
                      opacity: 0.9;
                  }
                  .info-box {
                      background: rgba(255,255,255,0.05);
                      padding: 30px;
                      border-radius: 15px;
                      margin-top: 20px;
                  }
                  .info-item {
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin: 15px 0;
                      padding: 15px;
                      background: rgba(255,255,255,0.03);
                      border-radius: 10px;
                  }
                  .label {
                      font-weight: bold;
                      color: #FFD700;
                      font-size: 1.1em;
                  }
                  .value {
                      font-size: 1.1em;
                      font-family: 'Courier New', monospace;
                  }
                  .status {
                      display: inline-block;
                      padding: 8px 20px;
                      background: #4CAF50;
                      border-radius: 20px;
                      font-weight: bold;
                      margin-top: 20px;
                      animation: pulse 2s infinite;
                  }
                  @keyframes pulse {
                      0%, 100% { opacity: 1; }
                      50% { opacity: 0.7; }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üöÄ DataExplorer</h1>
                  <p class="subtitle">Proyecto de Administraci√≥n de Sistemas</p>
                  <div class="status">‚úì Sistema Operativo</div>
                  <div class="info-box">
                      <div class="info-item">
                          <span class="label">Hostname:</span>
                          <span class="value">{{ ansible_hostname }}</span>
                      </div>
                      <div class="info-item">
                          <span class="label">IP Address:</span>
                          <span class="value">{{ ansible_default_ipv4.address }}</span>
                      </div>
                      <div class="info-item">
                          <span class="label">Sistema:</span>
                          <span class="value">{{ ansible_distribution }} {{ ansible_distribution_version }}</span>
                      </div>
                      <div class="info-item">
                          <span class="label">Servidor Web:</span>
                          <span class="value">Nginx</span>
                      </div>
                      <div class="info-item">
                          <span class="label">M√©tricas:</span>
                          <span class="value">Node Exporter activo</span>
                      </div>
                  </div>
              </div>
          </body>
          </html>
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: '0644'
    
    - name: Descargar Node Exporter
      get_url:
        url: "https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/{{ node_exporter_package }}.tar.gz"
        dest: /tmp/node_exporter.tar.gz
        mode: '0644'
        force: yes
      register: download_node_exporter
      retries: 3
      delay: 10
      until: download_node_exporter is success
    
    - name: Extraer Node Exporter
      unarchive:
        src: /tmp/node_exporter.tar.gz
        dest: /tmp/
        remote_src: yes
        creates: "/tmp/{{ node_exporter_package }}/node_exporter"
    
    - name: Copiar binario de Node Exporter
      copy:
        src: "/tmp/{{ node_exporter_package }}/node_exporter"
        dest: /usr/local/bin/node_exporter
        mode: '0755'
        remote_src: yes
    
    - name: Crear usuario para Node Exporter
      user:
        name: node_exporter
        shell: /bin/false
        system: yes
        create_home: no
        state: present
    
    - name: Crear servicio systemd para Node Exporter
      copy:
        content: |
          [Unit]
          Description=Node Exporter
          Documentation=https://prometheus.io/docs/guides/node-exporter/
          Wants=network-online.target
          After=network-online.target
          
          [Service]
          Type=simple
          User=node_exporter
          Group=node_exporter
          ExecStart=/usr/local/bin/node_exporter
          Restart=always
          RestartSec=5
          
          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/node_exporter.service
        mode: '0644'
    
    - name: Recargar systemd
      systemd:
        daemon_reload: yes
    
    - name: Iniciar y habilitar Node Exporter
      systemd:
        name: node_exporter
        state: started
        enabled: yes
    
    - name: Configurar Nginx para m√©tricas
      copy:
        content: |
          server {
              listen 80 default_server;
              listen [::]:80 default_server;
              server_name _;
              
              root /var/www/html;
              index index.html;
              
              location / {
                  try_files $uri $uri/ =404;
              }
              
              location /metrics {
                  proxy_pass http://127.0.0.1:9100/metrics;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              }
              
              location /nginx_status {
                  stub_status on;
                  access_log off;
                  allow 127.0.0.1;
                  allow 192.168.56.0/24;
                  deny all;
              }
          }
        dest: /etc/nginx/sites-available/default
        mode: '0644'
      notify: Reiniciar Nginx
    
    - name: Verificar configuraci√≥n de Nginx
      command: nginx -t
      register: nginx_test
      changed_when: false
    
    - name: Forzar restart de Nginx para aplicar cambios
      systemd:
        name: nginx
        state: restarted
    
    - name: Esperar a que los servicios est√©n disponibles
      wait_for:
        port: "{{ item }}"
        delay: 2
        timeout: 30
      loop:
        - 80
        - 9100
    
    - name: Mostrar informaci√≥n de acceso
      debug:
        msg:
          - "=========================================="
          - "    WEBSERVER CONFIGURADO EXITOSAMENTE    "
          - "=========================================="
          - ""
          - "Nginx: http://192.168.56.10 o http://localhost:8080"
          - "Node Exporter: http://192.168.56.10:9100 o http://localhost:9100"
          - ""
          - "P√°gina de m√©tricas: http://localhost:8080/metrics"
          - "=========================================="
  
  handlers:
    - name: Reiniciar Nginx
      systemd:
        name: nginx
        state: restarted
